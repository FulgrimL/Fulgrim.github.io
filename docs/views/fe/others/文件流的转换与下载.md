---
title: 文件流的转换与下载
date: 2020-10-29
tags:
 - 前端
categories:
 - 前端
sidebar: false
---

## 前言
说起文件，对于很多前后端初学者来讲，应该都是比较害怕的，对于文件流的概率，搞不清楚，有时候遇到问题也是不知道如何排除。下面我们来讲讲前端的文件处理

## 文件流

### 文件流相关接口
- 内置文件流接口：[Blob](https://developer.mozilla.org/zh-CN/docs/Web/API/Blob)（文件流接口定义）
- 内置文件流对象 ：[File](https://developer.mozilla.org/zh-CN/docs/Web/API/File)（单文件，继承于接口Blob，故可使用Blod的方法级）和 FileList（多文件集合）
- 内置文件流读取对象 ：[FileReader](https://developer.mozilla.org/zh-CN/docs/Web/API/FileReader)（单文件读取）

不了解这三个api的同学可以先去看看

## 文件流转换
### 1、file转base64

```
/**
 * 上传附件转base64
 * @param {File} file 文件流
 */
export const fileByBase64 = (file, callback) => {
  var reader = new FileReader();
  // 传入一个参数对象即可得到基于该参数对象的文本内容
  reader.readAsDataURL(file);
  reader.onload = function (e) {
    // target.result 该属性表示目标对象的DataURL
    console.log(e.target.result);
    callback(e.target.result)
  };
}
```
### 2、base64转blob
```
/**
 * base64转Blob
 * @param {*} data 
 */
export const base64ByBlob = (base64, callback) => {
  var arr = base64.split(','), mime = arr[0].match(/:(.*?);/)[1],
    bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
  while (n--) {
    u8arr[n] = bstr.charCodeAt(n);
  }
  console.log(new Blob([u8arr], { type: mime }))
  callback(new Blob([u8arr], { type: mime }))
}
```

### 3、blob转url

```
var url = window.URL.createObjectURL(blob)
```
### 4、使用demo

```
fileByBase64(file, (base64) => {
    base64ByBlob(base64, (blob => {
      console.log(blob, 'blob')
      var url = window.URL.createObjectURL(blob)
      console.log(url, 'url')
    })
})
```

## 文件下载
这里贴一段 项目里面的文件导出方法，需要的同学稍微改改就能用

**注意：创建本地下载链接createObjectURL这个方法，在chrome和IE创建的不一样，IE需要用window.navigator.msSaveOrOpenBlobc处理**

```
URL.createObjectURL(blob);

chrome： blob:http://192.168.0.1:8080/adsadsa-dasdsa-dasdsa

IE: blob: adsadsa-dasdsa-dasdsa
```


```
import axios from 'axios';
import request from '@/utils/request';
axios.defaults.timeout = 1000 * 60 * 5;

// 取response中的文件名称
const getFileNameFromHeader = headers => {
  if (!headers) {
    return '';
  }
  const contentDisposition = headers['content-disposition'];
  if (!contentDisposition) {
    return '';
  }
  const reg = /filename=(.*)/;
  const result = reg.exec(contentDisposition);
  return result ? decodeURI(result[1]) : '';
};

export default {
  // 下载文件， 传入文件流
  downloadByFile (res) {
    // 处理返回的文件流
    const content = res.data;
    const headers = res.headers;
    // 创建a标签
    const alink = document.createElement('a');
    // 文件名
    alink.download = getFileNameFromHeader(headers);
    // 开始下载
    alink.style.display = 'none';
    const blob = new Blob([content]);
    // for IE
    if (window.navigator && window.navigator.msSaveOrOpenBlob) {
      window.navigator.msSaveOrOpenBlob(blob, getFileNameFromHeader(headers));
    } else {
      // for No-IE
      alink.href = URL.createObjectURL(blob);
      document.body.appendChild(alink);
      // 触发点击a标签事件
      alink.click();
      document.body.removeChild(alink);
    }
  },

  // 下载文件， 传入接口名
  downloadByUrl (exportParams) {
    return new Promise(async (resolve, reject) => {
      const {
        url,
        params,
        fileName,
        method
      } = exportParams;
      const requestParams = {
        url: url,
        method: method || 'get',
        responseType: 'blob'
      };
      // 接口请求方式
      if (method === 'post') {
        requestParams.data = params;
      } else {
        requestParams.params = params;
      }
      try {
        const res = await request(requestParams);
        // 请求成功
        resolve(res);
        // 处理返回的文件流
        const content = res.data;
        const headers = res.headers;
        // 创建a标签
        const alink = document.createElement('a');
        // 文件名
        if (fileName) {
          alink.download = fileName;
        } else {
          alink.download = getFileNameFromHeader(headers);
        }
        // 开始下载
        alink.style.display = 'none';
        const blob = new Blob([content]);
        // for IE
        if (window.navigator && window.navigator.msSaveOrOpenBlob) {
          window.navigator.msSaveOrOpenBlob(blob, getFileNameFromHeader(headers));
        } else {
          // for No-IE
          alink.href = URL.createObjectURL(blob);
          document.body.appendChild(alink);
          // 触发点击a标签事件
          alink.click();
          document.body.removeChild(alink);
        }
      } catch (err) {
        reject(err);
      }
    });
  }
};


```




## 参考
- https://juejin.im/post/6844903617606975496
- https://segmentfault.com/a/1190000020153597
- https://segmentfault.com/a/1190000022208272